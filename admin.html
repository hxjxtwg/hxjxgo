<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航管理后台</title>
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="40" height="40" x="10" y="10" rx="5" fill="%23bb86fc"/><rect width="40" height="40" x="50" y="10" rx="5" fill="%23e0e0e0"/><rect width="40" height="40" x="10" y="50" rx="5" fill="%23e0e0e0"/><rect width="40" height="40" x="50" y="50" rx="5" fill="%23bb86fc"/></svg>'>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --text-color: #e0e0e0;
            --border-color: #333;
            --input-bg-color: #333;
            --input-border-color: #444;
            --item-bg-color: #2a2a2a;
            --error-color: #cf6679;
            --success-color: #03dac6;
        }
        body.light-mode {
            --bg-color: #f0f2f5;
            --surface-color: #ffffff;
            --primary-color: #6200ee;
            --text-color: #000000;
            --border-color: #e0e0e0;
            --input-bg-color: #f5f5f5;
            --input-border-color: #ccc;
            --item-bg-color: #eeeeee;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2 { color: var(--primary-color); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
        #password-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        #password-container input { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; padding: 10px; font-size: 1rem; width: 250px; text-align: center; margin-bottom: 1rem; }
        #password-container button { background-color: var(--primary-color); color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #admin-panel { display: none; }
        .section { background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        button { background-color: var(--primary-color); color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .delete-btn { background-color: transparent; color: var(--error-color); border: 1px solid var(--error-color); }
        .add-btn { background-color: transparent; color: var(--success-color); border: 1px solid var(--success-color); }
        #save-all-btn { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; font-size: 1rem; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 25px; border-radius: 8px; color: #000; font-weight: bold; visibility: hidden; opacity: 0; transition: opacity 0.5s, visibility 0.5s; z-index: 101; }
        #toast.show { visibility: visible; opacity: 1; }
        .theme-switcher { display: flex; align-items: center; }
        .theme-switcher label { width: 30px; height: 30px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .theme-switcher svg { position: absolute; width: 24px; height: 24px; transition: opacity 0.3s ease; stroke: var(--text-color); }
        .theme-switcher .sun-icon { opacity: 0; } body.light-mode .theme-switcher .sun-icon { opacity: 1; }
        .theme-switcher .moon-icon { opacity: 1; } body.light-mode .theme-switcher .moon-icon { opacity: 0; }
        .theme-switcher input { display: none; }
        
        .draggable-item { cursor: grab; background-color: var(--item-bg-color); margin-bottom: 10px; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .draggable-item.dragging { opacity: 0.4; }
        .drag-placeholder { height: 50px; background-color: rgba(187, 134, 252, 0.2); border: 2px dashed var(--primary-color); border-radius: 8px; margin: 10px 0; }
        .item-inputs { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .item-inputs input { background-color: var(--input-bg-color); border: 1px solid var(--input-border-color); color: var(--text-color); border-radius: 5px; padding: 8px; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        .handle { cursor: grab; padding: 0 10px; color: var(--text-secondary-color); font-size: 1.2rem; }
        
        .tree ul { list-style: none; padding-left: 25px; }
        .tree-item { padding: 10px; margin-bottom: 8px; border-radius: 8px; background-color: var(--item-bg-color); border: 1px solid var(--border-color); }
        .tree-item-content { display: flex; align-items: center; gap: 10px; }
        .item-controls { display: flex; gap: 5px; }
        .item-controls button { padding: 4px 8px; font-size: 0.8rem; }

        /* 改动：为卡片输入框设置特定的网格布局 */
        .tree-item[data-type="card"] .tree-item-inputs {
            grid-template-columns: 2fr 3fr 3fr; /* 名称:URL:图标 的比例 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="password-container">
            <h1>后台管理</h1>
            <input type="password" id="password" placeholder="请输入密码">
            <button id="login-btn">进入</button>
        </div>

        <div id="admin-panel">
            <div class="admin-header">
                <h1>导航管理后台</h1>
                <div class="theme-switcher">
                    <input type="checkbox" id="theme-toggle">
                    <label for="theme-toggle">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header"><h2>搜索引擎管理</h2><button class="add-btn" id="add-engine-btn">添加引擎</button></div>
                <div id="search-engines-container"></div>
            </div>

            <div class="section">
                <div class="section-header"><h2>结构编辑器</h2><button class="add-btn" id="add-menu-btn">添加主菜单</button></div>
                <div id="tree-container" class="tree"></div>
            </div>
        </div>
    </div>
    
    <button id="save-all-btn" style="display: none;">全部保存</button>
    <div id="toast"></div>

    <script>
        const passwordContainer = document.getElementById('password-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('login-btn');
        const passwordInput = document.getElementById('password');
        const saveAllBtn = document.getElementById('save-all-btn');
        const toast = document.getElementById('toast');
        const themeToggle = document.getElementById('theme-toggle');
        const searchEnginesContainer = document.getElementById('search-engines-container');
        const addEngineBtn = document.getElementById('add-engine-btn');
        const treeContainer = document.getElementById('tree-container');
        const addMenuBtn = document.getElementById('add-menu-btn');
        
        let appData = { navigation: [], search_engines: [] };

        // --- Theme ---
        function applyTheme(theme) {
            document.body.classList.toggle('light-mode', theme === 'light');
            themeToggle.checked = theme === 'light';
        }
        themeToggle.addEventListener('change', () => {
            const theme = themeToggle.checked ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });
        applyTheme(localStorage.getItem('theme') || 'dark');

        // --- Toast & API ---
        function showToast(message, isSuccess = true) {
            toast.textContent = message;
            toast.style.backgroundColor = isSuccess ? 'var(--success-color)' : 'var(--error-color)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        async function apiCall(action, data = null) {
            const password = passwordInput.value;
            const body = { password, action, key: 'app_data', data };
            if (data === null) delete body.data;
            const response = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (response.status === 401) throw new Error('密码错误');
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `${action} action failed`);
            }
            if (action === 'GET') return response.json();
        }

        // --- Login ---
        async function handleLogin() {
            try {
                appData = await apiCall('GET');
                if (!appData.navigation) appData.navigation = [];
                if (!appData.search_engines) appData.search_engines = [];
                passwordContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                saveAllBtn.style.display = 'block';
                renderSearchEngines();
                renderTree();
            } catch (error) { showToast(error.message, false); }
        }
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        
        // --- Renderers ---
        function renderSearchEngines() {
            searchEnginesContainer.innerHTML = '';
            (appData.search_engines || []).forEach((engine, index) => {
                const el = document.createElement('div');
                el.className = 'draggable-item';
                el.draggable = true;
                el.dataset.index = index;
                el.innerHTML = `
                    <span class="handle">☰</span>
                    <div class="item-inputs">
                        <input class="engine-name" value="${engine.name || ''}" placeholder="引擎名称">
                        <input class="engine-key" value="${engine.key || ''}" placeholder="唯一Key">
                        <input class="engine-icon" value="${engine.icon || ''}" placeholder="图标URL">
                        <input class="engine-url" value="${engine.url || ''}" placeholder="搜索URL (用{query})">
                    </div>
                    <button class="delete-btn" onclick="deleteEngine(${index})">X</button>
                `;
                searchEnginesContainer.appendChild(el);
            });
        }

        function renderTree() {
            treeContainer.innerHTML = '';
            const rootUl = document.createElement('ul');
            rootUl.style.paddingLeft = '0';
            (appData.navigation || []).forEach(item => rootUl.appendChild(createTreeItem(item)));
            treeContainer.appendChild(rootUl);
        }

        function createTreeItem(item) {
            const li = document.createElement('li');
            li.className = 'tree-item';
            li.dataset.id = item.id;
            li.dataset.type = item.type;
            li.setAttribute('draggable', true);

            let inputs = (item.type === 'card')
                ? `<div class="tree-item-inputs">
                       <input class="item-name" value="${item.name || ''}" placeholder="卡片名称">
                       <input class="item-url" value="${item.url || ''}" placeholder="URL">
                       <input class="item-icon" value="${item.icon || ''}" placeholder="图标 (可选)">
                   </div>`
                : `<div class="item-inputs"><input class="item-name" value="${item.name || ''}" placeholder="菜单名称"></div>`;
            
            let controls = '';
            if (item.type === 'menu') {
                controls = `<button class="add-btn" onclick="addItem('${item.id}', 'submenu')">＋二级菜单</button>
                            <button class="add-btn" onclick="addItem('${item.id}', 'card')">＋卡片</button>`;
            } else if (item.type === 'submenu') {
                controls = `<button class="add-btn" onclick="addItem('${item.id}', 'card')">＋卡片</button>`;
            }
            
            li.innerHTML = `
                <div class="tree-item-content">
                    <span class="handle">☰</span>
                    ${inputs}
                    <div class="item-controls">
                        ${controls}
                        <button class="delete-btn" onclick="deleteItem('${item.id}')">X</button>
                    </div>
                </div>
            `;

            if (item.children && item.children.length > 0) {
                const childrenUl = document.createElement('ul');
                item.children.forEach(child => childrenUl.appendChild(createTreeItem(child)));
                li.appendChild(childrenUl);
            }
            return li;
        }

        // --- Data Sync ---
        function syncDataFromDOM() {
            const newSearchEngines = [];
            document.querySelectorAll('#search-engines-container .draggable-item').forEach(el => {
                const name = el.querySelector('.engine-name').value.trim();
                const key = el.querySelector('.engine-key').value.trim();
                const icon = el.querySelector('.engine-icon').value.trim();
                const url = el.querySelector('.engine-url').value.trim();
                newSearchEngines.push({ name, key, icon, url });
            });
            appData.search_engines = newSearchEngines;

            function buildTree(element) {
                 const items = [];
                const children = element.children;
                for (let i = 0; i < children.length; i++) {
                    const li = children[i];
                    if (li.tagName !== 'LI' || li.classList.contains('drag-placeholder')) continue;
                    
                    const itemData = {
                        id: li.dataset.id,
                        type: li.dataset.type,
                        name: li.querySelector('.item-name').value.trim()
                    };
                    if (itemData.type === 'card') {
                        itemData.url = li.querySelector('.item-url').value.trim();
                        itemData.icon = li.querySelector('.item-icon').value.trim();
                    }
                    
                    const childrenUl = li.querySelector('ul');
                    if (childrenUl) itemData.children = buildTree(childrenUl);
                    items.push(itemData);
                }
                return items;
            }
            const rootUl = treeContainer.querySelector('ul');
            if (rootUl) {
                appData.navigation = buildTree(rootUl);
            } else {
                appData.navigation = [];
            }
        }
        
        // --- Manipulators ---
        addEngineBtn.addEventListener('click', () => {
            syncDataFromDOM();
            if (!appData.search_engines) appData.search_engines = [];
            appData.search_engines.push({ name: '新引擎', key: `se_${Date.now()}`, icon: '', url: 'https://www.google.com/search?q={query}' });
            renderSearchEngines();
        });

        function deleteEngine(index) {
            syncDataFromDOM();
            appData.search_engines.splice(index, 1);
            renderSearchEngines();
        }

        function findItem(data, id) {
            for (let i = 0; i < data.length; i++) {
                if (data[i].id === id) return { item: data[i] };
                if (data[i].children) {
                    const found = findItem(data[i].children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function addItem(parentId, type) {
            syncDataFromDOM();
            const parent = findItem(appData.navigation, parentId)?.item;
            if (parent) {
                if (!parent.children) parent.children = [];
                const newItem = { id: `item_${Date.now()}`, type };
                if (type === 'card') {
                    newItem.name = "新卡片"; newItem.url = "https://";
                } else {
                    newItem.name = "新二级菜单";
                }
                parent.children.push(newItem);
                renderTree();
            }
        }
        
        addMenuBtn.addEventListener('click', () => {
            syncDataFromDOM();
            if (!appData.navigation) appData.navigation = [];
            appData.navigation.push({ id: `item_${Date.now()}`, type: 'menu', name: '新主菜单', children: [] });
            renderTree();
        });

        function deleteItem(id) {
            syncDataFromDOM();
            function filterRecursive(items) {
                return items.filter(item => {
                    if (item.id === id) return false;
                    if (item.children) item.children = filterRecursive(item.children);
                    return true;
                });
            }
            appData.navigation = filterRecursive(appData.navigation);
            renderTree();
        }

        // --- Save ---
        saveAllBtn.addEventListener('click', async () => {
            syncDataFromDOM();
            try {
                await apiCall('SET', appData);
                showToast('保存成功!');
            } catch (error) { showToast(error.message, false); }
        });
        
        Object.assign(window, { deleteEngine, addItem, deleteItem });

    </script>
</body>
</html>

