<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航管理后台</title>
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="40" height="40" x="10" y="10" rx="5" fill="%23bb86fc"/><rect width="40" height="40" x="50" y="10" rx="5" fill="%23e0e0e0"/><rect width="40" height="40" x="10" y="50" rx="5" fill="%23e0e0e0"/><rect width="40" height="40" x="50" y="50" rx="5" fill="%23bb86fc"/></svg>'>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --text-color: #e0e0e0;
            --border-color: #333;
            --input-bg-color: #333;
            --input-border-color: #444;
            --item-bg-color: #2a2a2a;
            --error-color: #cf6679;
            --success-color: #03dac6;
            --drag-over-bg: rgba(187, 134, 252, 0.2);
        }
        body.light-mode {
            --bg-color: #f0f2f5;
            --surface-color: #ffffff;
            --primary-color: #6200ee;
            --text-color: #000000;
            --border-color: #e0e0e0;
            --input-bg-color: #f5f5f5;
            --input-border-color: #ccc;
            --item-bg-color: #eeeeee;
            --drag-over-bg: rgba(98, 0, 238, 0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2, h3 { color: var(--primary-color); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
        #password-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        #password-container input { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; padding: 10px; font-size: 1rem; width: 250px; text-align: center; margin-bottom: 1rem; }
        #password-container button { background-color: var(--primary-color); color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #admin-panel { display: none; }
        .section { background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        button { background-color: var(--primary-color); color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s, background-color 0.3s; }
        button:hover { opacity: 0.8; }
        .delete-btn { background-color: transparent; color: var(--error-color); border: 1px solid var(--error-color); display: flex; align-items: center; justify-content: center; padding: 6px; width: 32px; height: 32px; }
        .add-btn { background-color: transparent; color: var(--success-color); border: 1px solid var(--success-color); }
        #save-all-btn { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; font-size: 1rem; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 25px; border-radius: 8px; color: #000; font-weight: bold; visibility: hidden; opacity: 0; transition: opacity 0.5s, visibility 0.5s; z-index: 101; }
        #toast.show { visibility: visible; opacity: 1; }
        .theme-switcher { display: flex; align-items: center; }
        .theme-switcher label { width: 30px; height: 30px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .theme-switcher svg { position: absolute; width: 24px; height: 24px; transition: opacity 0.3s ease, transform 0.3s ease; stroke: var(--text-color); }
        .theme-switcher .sun-icon { opacity: 0; transform: rotate(-90deg); }
        .theme-switcher .moon-icon { opacity: 1; transform: rotate(0deg); }
        .theme-switcher input { display: none; }
        .theme-switcher input:checked + label .sun-icon { opacity: 1; transform: rotate(0deg); }
        .theme-switcher input:checked + label .moon-icon { opacity: 0; transform: rotate(90deg); }
        .draggable-item { cursor: grab; background-color: var(--item-bg-color); margin-bottom: 10px; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: background-color 0.3s, opacity 0.2s; }
        .draggable-item.dragging { opacity: 0.5; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .drag-over { border-top: 2px solid var(--primary-color); }
        .item-inputs { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .item-inputs input { background-color: var(--input-bg-color); border: 1px solid var(--input-border-color); color: var(--text-color); border-radius: 5px; padding: 8px; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        #category-selector { background-color: var(--input-bg-color); border: 1px solid var(--input-border-color); color: var(--text-color); border-radius: 5px; padding: 8px; font-size: 1rem; margin-left: 10px; }
        .group-editor { margin-bottom: 20px; background-color: var(--surface-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="password-container">
            <h1>后台管理</h1>
            <input type="password" id="password" placeholder="请输入密码">
            <button id="login-btn">进入</button>
        </div>

        <div id="admin-panel">
            <div class="admin-header">
                <h1>后台管理</h1>
                <div class="theme-switcher">
                    <input type="checkbox" id="theme-toggle">
                    <label for="theme-toggle">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>主菜单管理</h2>
                    <button class="add-btn" id="add-nav-item-btn">添加菜单项</button>
                </div>
                <div id="nav-items-container"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>分类链接管理: 
                        <select id="category-selector"></select>
                    </h2>
                </div>
                <div id="category-content-editor"></div>
            </div>
        </div>
    </div>
    
    <button id="save-all-btn" style="display: none;">全部保存</button>
    <div id="toast"></div>

    <script>
        const passwordContainer = document.getElementById('password-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('login-btn');
        const passwordInput = document.getElementById('password');
        const saveAllBtn = document.getElementById('save-all-btn');
        const toast = document.getElementById('toast');
        const themeToggle = document.getElementById('theme-toggle');
        const navItemsContainer = document.getElementById('nav-items-container');
        const addNavItemBtn = document.getElementById('add-nav-item-btn');
        const categorySelector = document.getElementById('category-selector');
        const categoryContentEditor = document.getElementById('category-content-editor');

        let mainNavData = [];
        let categoryDataCache = {};
        let currentEditingCategoryKey = null;
        let draggedItem = null;

        // --- Theme ---
        function applyTheme(theme) {
            document.body.classList.toggle('light-mode', theme === 'light');
            themeToggle.checked = theme === 'light';
        }
        themeToggle.addEventListener('change', () => {
            const theme = themeToggle.checked ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });
        applyTheme(localStorage.getItem('theme') || 'dark');

        // --- Toast ---
        function showToast(message, isSuccess = true) {
            toast.textContent = message;
            toast.style.backgroundColor = isSuccess ? 'var(--success-color)' : 'var(--error-color)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- API Helpers ---
        async function apiCall(action, key, data = null) {
            const password = passwordInput.value;
            const body = { password, action, key };
            if (data !== null) body.data = data;
            const response = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (response.status === 401) throw new Error('密码错误');
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `${action} action failed for key: ${key}`);
            }
            if (action === 'GET') return response.json();
        }

        // --- Login ---
        async function handleLogin() {
            try {
                mainNavData = await apiCall('GET', 'main_nav_config');
                passwordContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                saveAllBtn.style.display = 'block';
                renderMainNavEditor();
                if (mainNavData.length > 0) {
                    await loadCategoryForEditor(mainNavData[0].key);
                } else {
                    categoryContentEditor.innerHTML = '<p>请先在“主菜单管理”中添加一个菜单项。</p>';
                }
            } catch (error) {
                showToast(error.message, false);
            }
        }
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        // --- Data Sync ---
        function syncMainNavFromDOM() {
            const newMainNavData = [];
            document.querySelectorAll('#nav-items-container .draggable-item').forEach(el => {
                const name = el.querySelector('.nav-name').value.trim();
                const key = el.querySelector('.nav-key').value.trim();
                if (name && key) newMainNavData.push({ name, key });
            });
            mainNavData = newMainNavData;
        }

        function syncCurrentCategoryFromDOM() {
            const key = currentEditingCategoryKey;
            if (!key) return;
            const newCategoryData = { title: '', groups: [] };
            const titleInput = document.getElementById('category-title-input');
            if(titleInput) newCategoryData.title = titleInput.value.trim();
            document.querySelectorAll('#groups-container-editor .group-editor').forEach(groupEl => {
                const groupTitle = groupEl.querySelector('.group-title-input').value.trim();
                const links = [];
                groupEl.querySelectorAll('.links-container-editor .draggable-item').forEach(linkEl => {
                    const name = linkEl.querySelector('.link-name').value.trim();
                    const url = linkEl.querySelector('.link-url').value.trim();
                    const icon = linkEl.querySelector('.link-icon').value.trim();
                    if (name && url) {
                        const linkData = { name, url };
                        if (icon) linkData.icon = icon;
                        links.push(linkData);
                    }
                });
                if (groupTitle) newCategoryData.groups.push({ title: groupTitle, links });
            });
            categoryDataCache[key] = newCategoryData;
        }

        // --- Main Nav Editor ---
        function renderMainNavEditor() {
            navItemsContainer.innerHTML = '';
            mainNavData.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'draggable-item';
                el.draggable = true;
                el.dataset.index = index;
                el.innerHTML = `
                    <div class="item-inputs">
                        <input type="text" class="nav-name" value="${item.name}" placeholder="菜单名称">
                        <input type="text" class="nav-key" value="${item.key}" placeholder="唯一Key (英文)">
                    </div>
                    <button class="delete-btn" data-index="${index}">X</button>
                `;
                navItemsContainer.appendChild(el);
            });
            updateCategorySelector();
        }

        addNavItemBtn.addEventListener('click', () => {
            syncMainNavFromDOM();
            const newKey = `new_${Date.now()}`;
            mainNavData.push({ name: '新菜单', key: newKey });
            categoryDataCache[newKey] = { title: '新菜单', groups: [] };
            renderMainNavEditor();
            categorySelector.value = newKey;
            loadCategoryForEditor(newKey);
        });

        navItemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                syncMainNavFromDOM();
                const index = parseInt(e.target.dataset.index);
                const keyToDelete = mainNavData[index].key;
                mainNavData.splice(index, 1);
                delete categoryDataCache[keyToDelete];
                renderMainNavEditor();
                if (mainNavData.length > 0) {
                    loadCategoryForEditor(mainNavData[0].key);
                } else {
                    categoryContentEditor.innerHTML = '';
                    currentEditingCategoryKey = null;
                }
            }
        });
        
        // --- Category Selector ---
        function updateCategorySelector() {
            const selectedKey = categorySelector.value || (mainNavData[0] ? mainNavData[0].key : null);
            categorySelector.innerHTML = '';
            mainNavData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.key;
                option.textContent = item.name;
                categorySelector.appendChild(option);
            });
            if (selectedKey && mainNavData.some(item => item.key === selectedKey)) {
                categorySelector.value = selectedKey;
            }
        }
        categorySelector.addEventListener('change', (e) => {
            syncCurrentCategoryFromDOM(); // Save current before switching
            loadCategoryForEditor(e.target.value);
        });

        // --- Category Content Editor ---
        async function loadCategoryForEditor(key) {
            if (!key) {
                categoryContentEditor.innerHTML = '';
                currentEditingCategoryKey = null;
                return;
            }
            currentEditingCategoryKey = key;
            if (!categoryDataCache[key]) {
                try {
                    categoryDataCache[key] = await apiCall('GET', key);
                } catch (e) {
                    const navItem = mainNavData.find(i => i.key === key);
                    categoryDataCache[key] = { title: navItem ? navItem.name : '新分类', groups: [] };
                }
            }
            renderCategoryContentEditor();
        }

        function renderCategoryContentEditor() {
            const key = currentEditingCategoryKey;
            const data = categoryDataCache[key];
            if (!data) return;
            categoryContentEditor.innerHTML = `
                <div class="item-inputs" style="margin-bottom: 20px;">
                    <input type="text" id="category-title-input" value="${data.title}" placeholder="分类页标题 (用于浏览器标签)">
                </div>
                <div id="groups-container-editor"></div>
                <button class="add-btn" id="add-group-btn">添加分组</button>
            `;
            const container = document.getElementById('groups-container-editor');
            (data.groups || []).forEach((group, groupIndex) => {
                container.appendChild(createGroupEditor(groupIndex, group));
            });
            document.getElementById('add-group-btn').onclick = addGroup;
        }
        
        function createGroupEditor(groupIndex, group) {
            const groupEl = document.createElement('div');
            groupEl.className = 'group-editor draggable-item';
            groupEl.draggable = true;
            groupEl.dataset.index = groupIndex;
            groupEl.innerHTML = `
                <div class="item-inputs">
                    <input type="text" class="group-title-input" value="${group.title}" placeholder="分组标题">
                </div>
                <button class="delete-btn" data-index="${groupIndex}">X</button>
            `;
            const linksContainer = document.createElement('div');
            linksContainer.className = 'links-container-editor';
            linksContainer.style.paddingLeft = '20px';
            (group.links || []).forEach((link, linkIndex) => {
                linksContainer.appendChild(createLinkEditor(groupIndex, linkIndex, link));
            });
            groupEl.appendChild(linksContainer);
            const addLinkBtn = document.createElement('button');
            addLinkBtn.className = 'add-btn';
            addLinkBtn.textContent = '添加链接';
            addLinkBtn.dataset.groupIndex = groupIndex;
            addLinkBtn.style.marginTop = '10px';
            groupEl.appendChild(addLinkBtn);
            return groupEl;
        }

        function createLinkEditor(groupIndex, linkIndex, link) {
            const linkEl = document.createElement('div');
            linkEl.className = 'draggable-item';
            linkEl.draggable = true;
            linkEl.dataset.groupIndex = groupIndex;
            linkEl.dataset.index = linkIndex;
            linkEl.innerHTML = `
                <div class="item-inputs">
                    <input type="text" class="link-name" value="${link.name}" placeholder="名称">
                    <input type="text" class="link-url" value="${link.url}" placeholder="URL">
                    <input type="text" class="link-icon" value="${link.icon || ''}" placeholder="图标 (可选)">
                </div>
                <button class="delete-btn" data-group-index="${groupIndex}" data-index="${linkIndex}">X</button>
            `;
            return linkEl;
        }
        
        categoryContentEditor.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName !== 'BUTTON') return;
            syncCurrentCategoryFromDOM();
            const key = currentEditingCategoryKey;
            
            if (target.id === 'add-group-btn') {
                if (!categoryDataCache[key].groups) categoryDataCache[key].groups = [];
                categoryDataCache[key].groups.push({ title: '新分组', links: [] });
            } else if (target.textContent === '添加链接') {
                const groupIndex = parseInt(target.dataset.groupIndex);
                if (!categoryDataCache[key].groups[groupIndex].links) categoryDataCache[key].groups[groupIndex].links = [];
                categoryDataCache[key].groups[groupIndex].links.push({ name: '', url: '' });
            } else if (target.classList.contains('delete-btn')) {
                const groupIndex = parseInt(target.dataset.groupIndex ?? e.target.closest('.draggable-item').dataset.groupIndex);
                const index = parseInt(target.dataset.index);
                if (target.closest('.group-editor')) {
                    categoryDataCache[key].groups.splice(index, 1);
                } else {
                    categoryDataCache[key].groups[groupIndex].links.splice(index, 1);
                }
            }
            renderCategoryContentEditor();
        });
        
        // --- Save All ---
        saveAllBtn.addEventListener('click', async () => {
            try {
                syncMainNavFromDOM();
                syncCurrentCategoryFromDOM();

                await apiCall('SET', 'main_nav_config', mainNavData);

                for (const key in categoryDataCache) {
                   await apiCall('SET', key, categoryDataCache[key]);
                }
                
                showToast('全部保存成功!');
                renderMainNavEditor();
            } catch (error) {
                showToast(error.message, false);
            }
        });

        // --- Drag and Drop ---
        function handleDragStart(e) {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        function handleDragOver(e) {
            e.preventDefault();
            const container = e.currentTarget;
            const afterElement = getDragAfterElement(container, e.clientY);
            const dragging = container.querySelector('.dragging');
            if (dragging) {
                 if (afterElement == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, afterElement);
                }
            }
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        navItemsContainer.addEventListener('dragstart', handleDragStart);
        navItemsContainer.addEventListener('dragend', handleDragEnd);
        navItemsContainer.addEventListener('dragover', handleDragOver);

        categoryContentEditor.addEventListener('dragstart', handleDragStart);
        categoryContentEditor.addEventListener('dragend', handleDragEnd);
        categoryContentEditor.addEventListener('dragover', (e) => {
             e.preventDefault();
             const groupEditor = e.target.closest('.group-editor');
             if(draggedItem.classList.contains('group-editor') && groupEditor) { // Dragging group
                handleDragOver(e);
             } else if (draggedItem.classList.contains('draggable-item') && !draggedItem.classList.contains('group-editor') && groupEditor) { // Dragging link
                 const linksContainer = groupEditor.querySelector('.links-container-editor');
                 handleDragOver({currentTarget: linksContainer, clientY: e.clientY});
             }
        });

    </script>
</body>
</html>

