<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人导航</title>
    <link rel="icon" href="/my-logo.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-title">
                    <div class="header-logo"></div>
                    <h1 id="main-title">我的导航</h1>
                </div>
                <div class="theme-switcher">
                    <input type="checkbox" id="theme-toggle">
                    <label for="theme-toggle">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </label>
                </div>
            </div>
            <nav class="main-nav">
                <ul id="main-nav-ul">
                    <!-- 主导航菜单将由JS动态生成 -->
                </ul>
            </nav>
        </header>
        <main id="links-container">
            <!-- 链接卡片将由JS动态加载 -->
        </main>
    </div>

    <script>
        const linksContainer = document.getElementById('links-container');
        const themeToggle = document.getElementById('theme-toggle');
        const mainNavUl = document.getElementById('main-nav-ul');
        const mainTitle = document.getElementById('main-title');

        // --- 配置您的主菜单 ---
        // name: 显示的名称
        // key: 对应您在KV中设置的Key
        const mainNavItems = [
            { name: '首页', key: 'home' },
            { name: '技术工具', key: 'tech' },
            { name: '设计资源', key: 'design' },
            { name: '生活娱乐', key: 'life' }
        ];
        const DEFAULT_CATEGORY_KEY = 'home'; // 默认加载的分类

        // --- Theme Switcher Logic ---
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('light-mode');
                themeToggle.checked = false;
            }
        }
        themeToggle.addEventListener('change', () => {
            const theme = themeToggle.checked ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
        
        // --- 3D Tilt Effect Logic ---
        function applyTiltEffect() {
            const cards = document.querySelectorAll('.link-group a');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = (centerY - y) / 10;
                    const rotateY = (x - centerX) / 10;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
                });
            });
        }

        /**
         * 加载并渲染指定分类的链接
         */
        async function loadCategory(categoryKey, categoryName) {
            linksContainer.innerHTML = '<p class="placeholder">正在加载...</p>';
            mainTitle.textContent = categoryName;
            document.title = `${categoryName} - 个人导航`;

            // 更新主菜单的激活状态
            document.querySelectorAll('.main-nav a').forEach(a => {
                if (a.dataset.key === categoryKey) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });

            try {
                const response = await fetch(`/api/links?cat=${categoryKey}`);
                if (!response.ok) throw new Error('网络响应错误');
                const linkData = await response.json();

                if (!linkData.groups || linkData.groups.length === 0) {
                    linksContainer.innerHTML = '<p class="placeholder">暂无数据，请先前往后台添加。</p>';
                    return;
                }

                linksContainer.innerHTML = ''; 
                linkData.groups.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'link-group';
                    const title = document.createElement('h2');
                    title.className = 'card-group-title';
                    title.textContent = group.title;
                    groupDiv.appendChild(title);

                    const cardList = document.createElement('ul');
                    if(Array.isArray(group.links)) {
                        group.links.forEach(link => {
                            const cardItem = document.createElement('li');
                            const linkElement = document.createElement('a');
                            linkElement.href = link.url;
                            linkElement.target = '_blank';
                            linkElement.rel = 'noopener noreferrer';
                            const iconUrl = link.icon || `https://www.google.com/s2/favicons?domain=${new URL(link.url).hostname}&sz=32`;
                            linkElement.innerHTML = `
                                <div class="card-icon" style="background-image: url('${iconUrl}')"></div>
                                <span class="card-name">${link.name}</span>
                            `;
                            cardItem.appendChild(linkElement);
                            cardList.appendChild(cardItem);
                        });
                    }
                    groupDiv.appendChild(cardList);
                    linksContainer.appendChild(groupDiv);
                });
                
                applyTiltEffect();

            } catch (error) {
                console.error('加载链接失败:', error);
                linksContainer.innerHTML = '<p class="placeholder error">加载数据失败，请检查网络或后台配置。</p>';
            }
        }

        /**
         * 渲染主导航菜单
         */
        function renderMainNav() {
            mainNavUl.innerHTML = '';
            mainNavItems.forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = item.name;
                a.dataset.key = item.key;
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadCategory(item.key, item.name);
                });
                li.appendChild(a);
                mainNavUl.appendChild(li);
            });
        }
        
        // --- 初始加载 ---
        renderMainNav();
        const defaultCategory = mainNavItems.find(item => item.key === DEFAULT_CATEGORY_KEY) || mainNavItems[0];
        loadCategory(defaultCategory.key, defaultCategory.name);

    </script>
</body>
</html>

